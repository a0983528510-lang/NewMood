{% extends 'base.html' %}
{% block content %}
  <!-- é è¦½å€ï¼šæ‹ç«‹å¾—ç¿»è½‰ -->
  <div class="polaroid-stage">
    <div class="polaroid-container">
      <div class="polaroid instax-mini" id="preview-polaroid">
        <!-- èƒŒé¢ï¼šç°é»‘åº• -->
        <div class="polaroid-face back">
          <div class="back-content">
            <div class="back-seal">NewMood</div>
          </div>
        </div>
        <!-- æ­£é¢ï¼šç™½åº• + ç›¸æ¡† -->
        <div class="polaroid-face front">
          <div class="frame">
            <div class="band top"><span id="band-top-text">ç­‰å¾…è‡ªå‹•å¸¶å…¥â€¦</span></div>
            <div class="photo" id="preview-cover"><span class="cover-icon" id="cover-icon">ğŸµ</span></div>
            <div class="band bottom"><span id="band-bottom-text"></span></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% if not user %}
    <div class="sticky-wrap"><div class="sticky yellow">
      <p>Login to post your song and draw a random pick from others.</p>
      <a class="btn" href="{{ url_for('login') }}">Login with Google</a>
    </div></div>
  {% else %}
    <div class="sticky-wrap"><div class="sticky blue">
      <form id="post-form" method="post" action="{{ url_for('submit') }}">
        <label>Link (YouTube Music / Spotify / Apple Music)</label>
        <input type="url" name="link" id="input-link" placeholder="https://..." />

        <!-- è‡ªå‹•å¡«å…¥çš„æ­Œå / æ­Œæ‰‹ (éš±è—) -->
        <input type="hidden" name="title" id="input-title" />
        <input type="hidden" name="artist" id="input-artist" />

        <label>Why do you recommend it? (optional)</label>
        <textarea name="reason" id="input-reason" rows="3" placeholder="Short reason..."></textarea>

        <div style="display:flex; gap:8px; margin-top:8px;">
          <button class="btn" type="button" id="btn-autofill">AutoFill</button>
          <button class="btn" type="submit">Post & Draw</button>
        </div>
      </form>
      <div id="draw-result" class="draw-area" style="display:none;"></div>
    </div></div>
  {% endif %}

  <!-- Boot-dataï¼šå°‡æš±ç¨±è¼¸å‡ºæˆ JSONï¼ŒJS è§£æå¾Œä½¿ç”¨ -->
  <script id="boot-data" type="application/json">
    {{ {'nickname': (user.nickname if user else None)} | tojson }}
  </script>

  <script>
    const $ = (s) => document.querySelector(s);
    const form = document.getElementById('post-form');
    const linkInput = document.getElementById('input-link');
    const titleInput = document.getElementById('input-title');
    const artistInput = document.getElementById('input-artist');
    const reasonInput = document.getElementById('input-reason');

    // é è¦½å…ƒä»¶
    const preview    = document.getElementById('preview-polaroid');
    const cover      = document.getElementById('preview-cover');
    const coverIcon  = document.getElementById('cover-icon');
    const bandTop    = document.getElementById('band-top-text');
    const bandBottom = document.getElementById('band-bottom-text');

    // è®€å– boot-data ä¸­çš„æš±ç¨±
    const boot     = JSON.parse(document.getElementById('boot-data').textContent);
    const nickname = boot.nickname;

    // è‡ªå‹•å¡«å…¥è³‡æ–™
    async function doAutofill() {
      const link = (linkInput.value || '').trim();
      if (!link) { alert('è«‹å…ˆè²¼ä¸Šé€£çµ'); return; }
      const resp = await fetch('{{ url_for("autofill") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ link })
      });
      const data = await resp.json();
      if (!data.ok) { alert(data.error || 'AutoFill å¤±æ•—'); return; }
      const m = data.meta || {};
      // å¸¶å…¥éš±è—æ¬„ä½
      if (m.title)  titleInput.value  = m.title;
      if (m.artist) artistInput.value = m.artist;
      // å°é¢é¡¯ç¤º
      if (m.thumbnail) {
        cover.style.backgroundImage = 'url(' + m.thumbnail + ')';
        coverIcon.style.display = 'none';
      } else {
        cover.style.backgroundImage = '';
        coverIcon.style.display = '';
      }
      // æ›´æ–°ä¸Šç·£ï¼šæ­Œå â€” æš±ç¨±
      const nick = nickname || '';
      bandTop.textContent = (titleInput.value || '(No title)') + (nick ? ' â€” ' + nick : '');
      // ä¸‹ç·£ï¼šæ¨è–¦ç†ç”±
      bandBottom.textContent = reasonInput.value || '';
      // ç¿»ç‰Œï¼šå…ˆèƒŒé¢å†æ­£é¢
      preview.classList.remove('flip');
      setTimeout(() => {
        preview.classList.add('flip');
      }, 180);
    }

    // ç¶å®šäº‹ä»¶
    if (document.getElementById('btn-autofill')) {
      document.getElementById('btn-autofill').addEventListener('click', doAutofill);
    }
    if (linkInput) {
      linkInput.addEventListener('change', doAutofill);
    }
    if (reasonInput) {
      reasonInput.addEventListener('input', () => {
        bandBottom.textContent = reasonInput.value || '';
      });
    }

    // æäº¤è¡¨å–® â†’ æŠ½å¡å±•ç¤º
    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const fd = new FormData(form);
        const resp = await fetch(form.action, { method: 'POST', body: fd });
        const data = await resp.json();
        if (!data.ok) {
          alert(data.error || 'Error');
          return;
        }
        const resultDiv = document.getElementById('draw-result');
        resultDiv.style.display = 'block';

        if (data.drawn) {
          const d = data.drawn;
          const signer    = d.nickname ? d.nickname : '';
          const reasonTxt = d.reason   ? d.reason   : '';
          // é çµ„èƒŒæ™¯æ¨£å¼ï¼Œé¿å…å·¢ç‹€åå¼•è™Ÿ
          const bgStyle = d.thumbnail ? ' style="background-image:url(' + d.thumbnail + ')"' : '';
          // Play é€£çµ
          let linkHtml = '';
          if (d.link) {
            linkHtml = '<span class="play-link" style="margin-left:6px;"><a href="' + d.link + '" target="_blank" rel="noopener">Play</a></span>';
          }
          // çµ„å‡º HTML
          resultDiv.innerHTML = '<div class="polaroid-container">' +
            '<div class="polaroid instax-mini" id="draw-polaroid">' +
              '<div class="polaroid-face back">' +
                '<div class="back-content"><div class="back-seal">NewMood</div></div>' +
              '</div>' +
              '<div class="polaroid-face front">' +
                '<div class="frame">' +
                  '<div class="band top"><span><strong>' + d.title + '</strong>' + (signer ? ' â€” ' + signer : '') + '</span></div>' +
                  '<div class="photo"' + bgStyle + '>' + (d.thumbnail ? '' : '<span class="cover-icon">ğŸµ</span>') + '</div>' +
                  '<div class="band bottom"><span>' + reasonTxt + (linkHtml ? ' ' + linkHtml : '') + '</span></div>' +
                '</div>' +
              '</div>' +
            '</div>' +
          '</div>';
          setTimeout(() => {
            const p = document.getElementById('draw-polaroid');
            if (p) p.classList.add('flip');
          }, 220);
        } else {
          resultDiv.textContent = 'No other songs yetâ€”invite friends!';
        }
        // é‡ç½®è¡¨å–®
        form.reset();
      });
    }
  </script>
{% endblock %}
