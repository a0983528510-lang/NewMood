{% extends 'base.html' %}
{% block content %}
  <!-- é è¦½å€ï¼šæ‹ç«‹å¾—ç¿»è½‰ -->
  <div class="polaroid-stage">
    <div class="polaroid-container">
      <div class="polaroid instax-mini" id="preview-polaroid">
        <!-- èƒŒé¢ï¼ˆå…¨ CSS å¹¾ä½•å¡Šï¼‰ -->
        <div class="polaroid-face back">
          <div class="back-card">
            <div class="back-strip top"></div>
            <div class="back-strip bottom"></div>
            <div class="back-dash">Paste Link</div>
            <div class="back-brand">
              <span>NewMood</span><span>NewMood</span><span>NewMood</span>
            </div>
          </div>
        </div>

        <!-- æ­£é¢ï¼ˆç™½è‰²æ‹ç«‹å¾—ï¼‰ -->
        <div class="polaroid-face front">
          <div class="frame">
            <!-- ç›¸ç‰‡çª— -->
            <div class="photo">
              <div class="cover" id="preview-cover">
                <span class="cover-icon" id="cover-icon">ðŸŽµ</span>
              </div>

              <!-- é»ƒè‰²æ–œé«”æ­Œåï¼ä½œè€… -->
              <div class="overlay-title" id="overlay-title">Title â€” Artist</div>
            </div>

            <!-- æ–‡å­—å€å¡Šï¼ˆæŽ¨è–¦äººã€ç†ç”±ã€å³ä¸‹è§’å“ç‰Œï¼‰ -->
            <div class="info">
              <div class="signer" id="signer-name">YOUR NAME</div>
              <div class="reason" id="reason-text"></div>
              <div class="brand-mark">NewMood</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% if not user %}
    <div class="sticky-wrap"><div class="sticky yellow">
      <p>Login to post your song and draw a random pick from others.</p>
      <a class="btn" href="{{ url_for('login') }}">Login with Google</a>
    </div></div>
  {% else %}
    <div class="sticky-wrap"><div class="sticky blue" style="background:transparent;border:none;box-shadow:none;">
      <form id="post-form" method="post" action="{{ url_for('submit') }}">
        <!-- éš±è—æ¬„ä½ï¼šä»æ²¿ç”¨ -->
        <input type="hidden" name="title" id="input-title" />
        <input type="hidden" name="artist" id="input-artist" />

        <!-- URL + é»ƒè‰² AutoFillï¼ˆèˆ‡ Figma å°é½Šï¼‰ -->
        <div class="form-row">
          <input type="url" name="link" id="input-link" class="input-url"
                 placeholder="SONG LINKï¼ˆYouTube Music / Spotify / Apple Musicï¼‰" />
          <button class="btn-yellow" type="button" id="btn-autofill">FILL</button>
        </div>

        <!-- Link toï¼šä¸‰å€‹åœ“å½¢å¿«é€Ÿé€£çµ -->
        <div class="quick-links">
          <span class="quick-label">LINK TOï¼š</span>
          <a class="quick-btn yt" href="https://music.youtube.com" target="_blank" rel="noopener" aria-label="YouTube Music"></a>
          <a class="quick-btn sp" href="https://open.spotify.com" target="_blank" rel="noopener" aria-label="Spotify"></a>
          <a class="quick-btn am" href="https://music.apple.com" target="_blank" rel="noopener" aria-label="Apple Music"></a>
        </div>

        <!-- ç†ç”±è¼¸å…¥æ¡†ï¼ˆå¤§ç™½æ¡†ï¼‰ -->
        <div class="textarea-row">
          <textarea name="reason" id="input-reason" rows="4"
            placeholder="WHY DO YOU RECOMMEND IT ? (Optional)"></textarea>
        </div>

        <!-- é€å‡ºæŒ‰éˆ• -->
        <div class="submit-row">
          <button class="btn-pill" type="submit">Post & Draw</button>
        </div>
      </form>

      <div id="draw-result" class="draw-area" style="display:none;"></div>
    </div></div>
  {% endif %}

  <!-- Boot-dataï¼šå°‡æš±ç¨±è¼¸å‡ºæˆ JSONï¼ŒJS è§£æžå¾Œä½¿ç”¨ -->
  <script id="boot-data" type="application/json">
    {{ {'nickname': (user.nickname if user else None)} | tojson }}
  </script>

  <script>
    const $ = (s) => document.querySelector(s);
    const form = document.getElementById('post-form');
    const linkInput = document.getElementById('input-link');
    const titleInput = document.getElementById('input-title');
    const artistInput = document.getElementById('input-artist');
    const reasonInput = document.getElementById('input-reason');

    // é è¦½å…ƒä»¶
    const preview    = document.getElementById('preview-polaroid');
    const cover      = document.getElementById('preview-cover');
    const coverIcon  = document.getElementById('cover-icon');
    const overlay    = document.getElementById('overlay-title');
    const signerEl   = document.getElementById('signer-name');
    const reasonEl   = document.getElementById('reason-text');

    // æš±ç¨±
    const boot = JSON.parse(document.getElementById('boot-data').textContent);
    const nickname = boot.nickname || '';

    // è‡ªå‹•å¡«å…¥
    async function doAutofill() {
      const link = (linkInput.value || '').trim();
      if (!link) { alert('è«‹å…ˆè²¼ä¸Šé€£çµ'); return; }

      const resp = await fetch('{{ url_for("autofill") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ link })
      });
      const data = await resp.json();
      if (!data.ok) { alert(data.error || 'AutoFill å¤±æ•—'); return; }
      const m = data.meta || {};

      // éš±è—æ¬„ä½
      if (m.title)  titleInput.value  = m.title;
      if (m.artist) artistInput.value = m.artist;

      // åœ–ç‰‡
      if (m.thumbnail) {
        cover.style.backgroundImage = 'url(' + m.thumbnail + ')';
        coverIcon.style.display = 'none';
      } else {
        cover.style.backgroundImage = '';
        coverIcon.style.display = '';
      }

      // è¦†è“‹æ¨™é¡Œï¼šTitle â€” Artistï¼ˆé»ƒè‰²æ–œé«”ï¼‰
      const t = titleInput.value || '(No title)';
      const a = artistInput.value || '';
      overlay.textContent = a ? `${t} â€” ${a}` : t;

      // æŽ¨è–¦äºº / ç†ç”±
      signerEl.textContent = nickname || '';
      reasonEl.textContent = reasonInput.value || '';

      // ç¿»è½‰å‹•ç•«ï¼ˆåŠ ä¸€åœˆæ—‹è½‰ï¼‰
      preview.classList.remove('flip','spin');
      void preview.offsetWidth; // é‡æ–°è§¸ç™¼å‹•ç•«
      preview.classList.add('flip','spin');
    }

    // ç¶å®š
    const btnAuto = document.getElementById('btn-autofill');
    if (btnAuto) btnAuto.addEventListener('click', doAutofill);
    if (linkInput) linkInput.addEventListener('change', doAutofill);
    if (reasonInput) {
      reasonInput.addEventListener('input', () => {
        reasonEl.textContent = reasonInput.value || '';
      });
    }

    // æäº¤ â†’ æŠ½å¡å±•ç¤ºï¼ˆç¶­æŒåŽŸæµç¨‹ï¼›å¡ç‰‡æ¨£å¼æ²¿ç”¨æœ¬é ï¼‰
    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const fd = new FormData(form);
        const resp = await fetch(form.action, { method: 'POST', body: fd });
        const data = await resp.json();
        if (!data.ok) { alert(data.error || 'Error'); return; }

        const resultDiv = document.getElementById('draw-result');
        resultDiv.style.display = 'block';

        if (data.drawn) {
          const d = data.drawn;
          const signer    = d.nickname ? d.nickname : '';
          const reasonTxt = d.reason   ? d.reason   : '';
          const bgStyle   = d.thumbnail ? ' style="background-image:url(' + d.thumbnail + ')"' : '';

          resultDiv.innerHTML = `
          <div class="polaroid-container">
            <div class="polaroid instax-mini" id="draw-polaroid">
              <div class="polaroid-face back">
                <div class="back-card">
                  <div class="back-strip top"></div>
                  <div class="back-strip bottom"></div>
                  <div class="back-dash">Play</div>
                  <div class="back-brand"><span>NewMood</span><span>NewMood</span><span>NewMood</span></div>
                </div>
              </div>
              <div class="polaroid-face front">
                <div class="frame">
                  <div class="photo">
                    <div class="cover"${bgStyle}>${d.thumbnail ? '' : '<span class="cover-icon">ðŸŽµ</span>'}</div>
                    <div class="overlay-title">${d.title}${d.artist ? ' â€” ' + d.artist : ''}</div>
                  </div>
                  <div class="info">
                    <div class="signer">${signer}</div>
                    <div class="reason">${reasonTxt}${d.link ? ' <span class="play-link"><a href="'+d.link+'" target="_blank" rel="noopener">Play</a></span>' : ''}</div>
                    <div class="brand-mark">NewMood</div>
                  </div>
                </div>
              </div>
            </div>
          </div>`;

          setTimeout(() => {
            const p = document.getElementById('draw-polaroid');
            if (p) { p.classList.add('flip','spin'); }
          }, 200);
        } else {
          resultDiv.textContent = 'No other songs yetâ€”invite friends!';
        }

        form.reset();
      });
    }
  </script>
{% endblock %}
