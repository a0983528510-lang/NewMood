{% extends 'base.html' %}
{% block content %}
  <div class="sticky-wrap">
    <div class="sticky yellow">
      <h2>Post one track, get one back.</h2>
      {% if not user %}
      <p>Login to post your song and draw a random pick from others.</p>
      <a class="btn" href="{{ url_for('login') }}">Login with Google</a>
      {% else %}
      <form id="post-form" method="post" action="{{ url_for('submit') }}">
        <label>Song title</label>
        <input type="text" name="title" required placeholder="e.g., Plastic Love" />
        <label>Artist</label>
        <input type="text" name="artist" required placeholder="e.g., Mariya Takeuchi" />
        <label>Why do you recommend it? (optional)</label>
        <textarea name="reason" rows="3" placeholder="Short reason..."></textarea>
        <label>Link (YouTube/Spotify)</label>
        <input type="url" name="link" placeholder="https://..." />
        <button class="btn" type="submit" onclick="gtag && gtag('event','post_and_draw_clicked')">Post & Draw</button>
      </form>
      <div id="draw-result" class="draw-area" style="display:none;"></div>
      {% endif %}
    </div>
  </div>

  <script>
    // Handle the post form submission and display the drawn recommendation as a
    // Polaroid card.  When a recommendation is drawn the card first shows
    // its back (featuring the NewMood logo) then flips over to reveal the
    // track details.
    const form = document.getElementById('post-form');
    const result = document.getElementById('draw-result');
    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const fd = new FormData(form);
        const resp = await fetch(form.action, {method: 'POST', body: fd});
        const data = await resp.json();
        if (!data.ok) {
          alert(data.error || 'Error');
          return;
        }
        // Reset form regardless of draw outcome
        form.reset();
        if (data.drawn) {
          // Build the Polaroid markup.  Use template literals to insert
          // dynamic values safely.  Escape text with innerText assignment to
          // avoid HTML injection, but here assume trusted data.
          const drawn = data.drawn;
          result.style.display = 'block';
          // Build front face content: title, artist, optional link and reason,
          // plus signature (nickname) if available.
          const titleArtist = `<strong>${drawn.title}</strong> — ${drawn.artist}`;
          const linkPart = drawn.link ? `<div class="play-link"><a href="${drawn.link}" target="_blank">Play</a></div>` : '';
          const reasonPart = drawn.reason ? `<div class="reason">${drawn.reason}</div>` : '';
          const signerPart = drawn.nickname ? `<div class="signer">— ${drawn.nickname}</div>` : '';
          result.innerHTML = `
            <div class="polaroid-container">
              <div class="polaroid" id="draw-polaroid">
                <div class="polaroid-face back">
                  <div class="back-content">
                    <img src="/static/images/logo.png" alt="NewMood logo" class="back-logo" />
                    <div class="back-text">NewMood</div>
                  </div>
                </div>
                <div class="polaroid-face front">
                  <div class="cover"><span class="cover-icon">🎵</span></div>
                  <div class="info">
                    <div class="title-artist">${titleArtist}</div>
                    ${linkPart}
                    ${reasonPart}
                    ${signerPart}
                  </div>
                </div>
              </div>
            </div>`;
          // Trigger the flip after a short delay so the user sees the back
          // briefly, simulating an “抽卡” effect.
          setTimeout(() => {
            const p = document.getElementById('draw-polaroid');
            if (p) {
              p.classList.add('flip');
            }
          }, 500);
          // Scroll to the result
          window.scrollTo({ top: result.offsetTop - 20, behavior: 'smooth' });
        } else {
          result.style.display = 'block';
          result.textContent = 'No other songs yet—invite friends!';
        }
      });
    }
  </script>
{% endblock %}
