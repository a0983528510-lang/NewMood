{% extends 'base.html' %}
{% block content %}
  <!-- Polaroid Preview Stage -->
  <div class="polaroid-stage">
    <div class="polaroid-container">
      <div class="polaroid" id="preview-polaroid">
        <!-- èƒŒé¢ï¼šç°é»‘ -->
        <div class="polaroid-face back">
          <div class="back-content">
            <div class="back-seal">NewMood</div>
          </div>
        </div>
        <!-- æ­£é¢ï¼šç™½åº• + å¤–æ¡† + æ–¹å½¢ç›¸ç´™çª— -->
        <div class="polaroid-face front">
          <div class="frame">
            <div class="band top"><span id="band-top-text">ç­‰å¾…è‡ªå‹•å¸¶å…¥â€¦</span></div>
            <div class="photo" id="preview-cover"><span class="cover-icon" id="cover-icon">ğŸµ</span></div>
            <div class="band bottom"><span id="band-bottom-text"></span></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% if not user %}
    <div class="sticky-wrap"><div class="sticky yellow">
      <p>Login to post your song and draw a random pick from others.</p>
      <a class="btn" href="{{ url_for('login') }}">Login with Google</a>
    </div></div>
  {% else %}
    <div class="sticky-wrap"><div class="sticky blue">
      <form id="post-form" method="post" action="{{ url_for('submit') }}">
        <label>Link (YouTube Music / Spotify / Apple Music)</label>
        <input type="url" name="link" id="input-link" placeholder="https://..." />

        <!-- Title/Artist ç”± AutoFill å¯«å…¥çš„éš±è—æ¬„ä½ -->
        <input type="hidden" name="title" id="input-title" />
        <input type="hidden" name="artist" id="input-artist" />

        <label>Why do you recommend it? (optional)</label>
        <textarea name="reason" id="input-reason" rows="3" placeholder="Short reason..."></textarea>

        <div style="display:flex; gap:8px; margin-top:8px;">
          <button class="btn" type="button" id="btn-autofill">AutoFill</button>
          <button class="btn" type="submit">Post & Draw</button>
        </div>
      </form>
      <div id="draw-result" class="draw-area" style="display:none;"></div>
    </div></div>
  {% endif %}
  <script id="boot-data" type="application/json">
    {{ {'nickname': (user.nickname if user else None)} | tojson }}
  </script>
  <script>
  // â€¦å‰ç•¥ï¼ˆä¸Šé¢çš„ç¨‹å¼ç¢¼ä¸è®Šï¼‰

  // ç°¡å–®æ·¨åŒ–ï¼Œé¿å…æŠŠå¥‡æ€ªå­—å…ƒæ’é€² HTML
  const safe = (s) => (s ?? '').toString();

  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(form);
      const resp = await fetch(form.action, { method: 'POST', body: fd });
      const data = await resp.json();
      if (!data.ok) { alert(data.error || 'Error'); return; }

      const result = document.getElementById('draw-result');
      result.style.display = 'block';

      if (data.drawn) {
        const d = data.drawn;
        const signer = d.nickname ? d.nickname : '';
        const reason = d.reason ? d.reason : '';

        // å…ˆæŠŠ style å­—ä¸²çµ„å¥½ï¼ˆé¿å…åœ¨æ¨£æ¿å­—ä¸²è£¡å†æ‹¼åå¼•è™Ÿï¼‰
        const bgStyle = d.thumbnail
          ? ' style="background-image:url(' + d.thumbnail + ');background-size:cover;background-position:center;background-repeat:no-repeat;"'
          : '';

        // âœ… é€™è£¡ä¸€å®šè¦æœ‰çµå°¾çš„ ` å’Œ ;
        result.innerHTML = `
          <div class="polaroid-container">
            <div class="polaroid" id="draw-polaroid">
              <div class="polaroid-face back">
                <div class="back-content"><div class="back-seal">NewMood</div></div>
              </div>
              <div class="polaroid-face front">
                <div class="frame">
                  <div class="band top">
                    <span><strong>${safe(d.title)}</strong>${signer ? ' â€” ' + safe(signer) : ''}</span>
                  </div>
                  <div class="photo"${bgStyle}>
                    ${d.thumbnail ? '' : '<span class="cover-icon">ğŸµ</span>'}
                  </div>
                  <div class="band bottom">
                    <span>
                      ${safe(reason)}
                      ${d.link ? '<span class="play-link" style="margin-left:6px;"><a href="' + d.link + '" target="_blank" rel="noopener">Play</a></span>' : ''}
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `; // â† æ”¶å°¾çš„åå¼•è™Ÿèˆ‡åˆ†è™Ÿ

        setTimeout(() => document.getElementById('draw-polaroid')?.classList.add('flip'), 220);
      } else {
        result.textContent = 'No other songs yetâ€”invite friends!';
      }

      form.reset();
    });
  }
</script>