{% extends 'base.html' %}
{% block content %}
  <!-- 預覽區：拍立得翻轉 -->
  <div class="polaroid-stage">
    <div class="polaroid-container">
      <div class="polaroid instax-mini" id="preview-polaroid">
        <!-- 背面：灰黑底 -->
        <div class="polaroid-face back">
          <div class="back-content">
            <div class="back-seal">NewMood</div>
          </div>
        </div>
        <!-- 正面：白底 + 相框 -->
        <div class="polaroid-face front">
          <div class="frame">
            <div class="band top"><span id="band-top-text">等待自動帶入…</span></div>
            <div class="photo" id="preview-cover"><span class="cover-icon" id="cover-icon">🎵</span></div>
            <div class="band bottom"><span id="band-bottom-text"></span></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% if not user %}
    <div class="sticky-wrap"><div class="sticky yellow">
      <p>Login to post your song and draw a random pick from others.</p>
      <a class="btn" href="{{ url_for('login') }}">Login with Google</a>
    </div></div>
  {% else %}
    <div class="sticky-wrap"><div class="sticky blue">
      <form id="post-form" method="post" action="{{ url_for('submit') }}">
        <label>Link (YouTube Music / Spotify / Apple Music)</label>
        <input type="url" name="link" id="input-link" placeholder="https://..." />

        <!-- 自動填入的歌名 / 歌手 (隱藏) -->
        <input type="hidden" name="title" id="input-title" />
        <input type="hidden" name="artist" id="input-artist" />

        <label>Why do you recommend it? (optional)</label>
        <textarea name="reason" id="input-reason" rows="3" placeholder="Short reason..."></textarea>

        <div style="display:flex; gap:8px; margin-top:8px;">
          <button class="btn" type="button" id="btn-autofill">AutoFill</button>
          <button class="btn" type="submit">Post & Draw</button>
        </div>
      </form>
      <div id="draw-result" class="draw-area" style="display:none;"></div>
    </div></div>
  {% endif %}

  <!-- Boot-data：將暱稱輸出成 JSON，JS 解析後使用 -->
  <script id="boot-data" type="application/json">
    {{ {'nickname': (user.nickname if user else None)} | tojson }}
  </script>

  <script>
    const $ = (s) => document.querySelector(s);
    const form = document.getElementById('post-form');
    const linkInput = document.getElementById('input-link');
    const titleInput = document.getElementById('input-title');
    const artistInput = document.getElementById('input-artist');
    const reasonInput = document.getElementById('input-reason');

    // 預覽元件
    const preview    = document.getElementById('preview-polaroid');
    const cover      = document.getElementById('preview-cover');
    const coverIcon  = document.getElementById('cover-icon');
    const bandTop    = document.getElementById('band-top-text');
    const bandBottom = document.getElementById('band-bottom-text');

    // 讀取 boot-data 中的暱稱
    const boot     = JSON.parse(document.getElementById('boot-data').textContent);
    const nickname = boot.nickname;

    // 自動填入資料
    async function doAutofill() {
      const link = (linkInput.value || '').trim();
      if (!link) { alert('請先貼上連結'); return; }
      const resp = await fetch('{{ url_for("autofill") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ link })
      });
      const data = await resp.json();
      if (!data.ok) { alert(data.error || 'AutoFill 失敗'); return; }
      const m = data.meta || {};
      // 帶入隱藏欄位
      if (m.title)  titleInput.value  = m.title;
      if (m.artist) artistInput.value = m.artist;
      // 封面顯示
      if (m.thumbnail) {
        cover.style.backgroundImage = 'url(' + m.thumbnail + ')';
        coverIcon.style.display = 'none';
      } else {
        cover.style.backgroundImage = '';
        coverIcon.style.display = '';
      }
      // 更新上緣：歌名 — 暱稱
      const nick = nickname || '';
      bandTop.textContent = (titleInput.value || '(No title)') + (nick ? ' — ' + nick : '');
      // 下緣：推薦理由
      bandBottom.textContent = reasonInput.value || '';
      // 翻牌：先背面再正面
      preview.classList.remove('flip');
      setTimeout(() => {
        preview.classList.add('flip');
      }, 180);
    }

    // 綁定事件
    if (document.getElementById('btn-autofill')) {
      document.getElementById('btn-autofill').addEventListener('click', doAutofill);
    }
    if (linkInput) {
      linkInput.addEventListener('change', doAutofill);
    }
    if (reasonInput) {
      reasonInput.addEventListener('input', () => {
        bandBottom.textContent = reasonInput.value || '';
      });
    }

    // 提交表單 → 抽卡展示
    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const fd = new FormData(form);
        const resp = await fetch(form.action, { method: 'POST', body: fd });
        const data = await resp.json();
        if (!data.ok) {
          alert(data.error || 'Error');
          return;
        }
        const resultDiv = document.getElementById('draw-result');
        resultDiv.style.display = 'block';

        if (data.drawn) {
          const d = data.drawn;
          const signer    = d.nickname ? d.nickname : '';
          const reasonTxt = d.reason   ? d.reason   : '';
          // 預組背景樣式，避免巢狀反引號
          const bgStyle = d.thumbnail ? ' style="background-image:url(' + d.thumbnail + ')"' : '';
          // Play 連結
          let linkHtml = '';
          if (d.link) {
            linkHtml = '<span class="play-link" style="margin-left:6px;"><a href="' + d.link + '" target="_blank" rel="noopener">Play</a></span>';
          }
          // 組出 HTML
          resultDiv.innerHTML = '<div class="polaroid-container">' +
            '<div class="polaroid instax-mini" id="draw-polaroid">' +
              '<div class="polaroid-face back">' +
                '<div class="back-content"><div class="back-seal">NewMood</div></div>' +
              '</div>' +
              '<div class="polaroid-face front">' +
                '<div class="frame">' +
                  '<div class="band top"><span><strong>' + d.title + '</strong>' + (signer ? ' — ' + signer : '') + '</span></div>' +
                  '<div class="photo"' + bgStyle + '>' + (d.thumbnail ? '' : '<span class="cover-icon">🎵</span>') + '</div>' +
                  '<div class="band bottom"><span>' + reasonTxt + (linkHtml ? ' ' + linkHtml : '') + '</span></div>' +
                '</div>' +
              '</div>' +
            '</div>' +
          '</div>';
          setTimeout(() => {
            const p = document.getElementById('draw-polaroid');
            if (p) p.classList.add('flip');
          }, 220);
        } else {
          resultDiv.textContent = 'No other songs yet—invite friends!';
        }
        // 重置表單
        form.reset();
      });
    }
  </script>
{% endblock %}
