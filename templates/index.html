{% extends 'base.html' %}
{% block content %}
  <!-- 預覽區：拍立得翻轉（照片版） -->
  <div class="polaroid-stage">
    <div class="polaroid-container">
      <div class="polaroid" id="preview-polaroid">
        <!-- 背面（整張貼圖） -->
        <div class="face back" title="點擊翻面"></div>

        <!-- 正面（整張貼圖） -->
        <div class="face front" title="點擊翻面">
          <!-- 縮圖窗（綠色區域對位） -->
          <div class="window" id="preview-window">
            <img id="preview-thumb" alt="thumbnail" />
          </div>
          <!-- 黃字：歌名 — 歌手（中文/英文可各自字體） -->
          <div class="song-line" id="preview-songline">
            <span class="zh">(No title)</span><span class="sep" style="display:none;"> — </span><span class="en"></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% if not user %}
    <div class="sticky-wrap"><div class="sticky yellow">
      <p>Login to post your song and draw a random pick from others.</p>
      <a class="btn" href="{{ url_for('login') }}">Login with Google</a>
    </div></div>
  {% else %}
    <div class="sticky-wrap"><div class="sticky blue" style="background:transparent;border:none;box-shadow:none;">
      <form id="post-form" method="post" action="{{ url_for('submit') }}">
        <label>Link (YouTube Music / Spotify / Apple Music)</label>
        <input type="url" name="link" id="input-link" placeholder="https://..." />

        <!-- 隱藏欄位（沿用原流程） -->
        <input type="hidden" name="title" id="input-title" />
        <input type="hidden" name="artist" id="input-artist" />

        <label>Why do you recommend it? (optional)</label>
        <textarea name="reason" id="input-reason" rows="3" placeholder="Short reason..."></textarea>

        <div style="display:flex; gap:8px; margin-top:8px;">
          <button class="btn" type="button" id="btn-autofill">AutoFill</button>
          <button class="btn" type="submit">Post & Draw</button>
        </div>
      </form>
      <div id="draw-result" class="draw-area" style="display:none;"></div>
    </div></div>
  {% endif %}

  <!-- Boot-data：輸出暱稱 -->
  <script id="boot-data" type="application/json">
    {{ {'nickname': (user.nickname if user else None)} | tojson }}
  </script>

  <script>
    const $ = (s) => document.querySelector(s);

    const form        = document.getElementById('post-form');
    const linkInput   = document.getElementById('input-link');
    const titleInput  = document.getElementById('input-title');
    const artistInput = document.getElementById('input-artist');
    const reasonInput = document.getElementById('input-reason');

    // 預覽卡元素（照片版）
    const card       = document.getElementById('preview-polaroid');
    const winEl      = document.getElementById('preview-window');
    const imgEl      = document.getElementById('preview-thumb');
    const lineEl     = document.getElementById('preview-songline');
    const zhEl       = lineEl?.querySelector('.zh');
    const enEl       = lineEl?.querySelector('.en');
    const sepEl      = lineEl?.querySelector('.sep');

    // 使用者暱稱
    const boot     = JSON.parse(document.getElementById('boot-data').textContent);
    const nickname = boot.nickname || '';

    // 縮圖寫入（雙保險）
    function setThumbnail(url){
      if (!url) { imgEl.removeAttribute('src'); winEl.style.backgroundImage=''; return; }
      imgEl.src = url;
      winEl.style.backgroundImage = 'url(' + url + ')';
    }
    // 文字寫入
    function setTitleArtist(title, artist){
      const t = (title || '(No title)').trim();
      const a = (artist || '').trim();
      if (zhEl) zhEl.textContent = t;
      if (enEl) enEl.textContent = a;
      if (sepEl) sepEl.style.display = a ? '' : 'none';
    }

    // AutoFill 主流程（沿用你的 /autofill 後端）
    async function doAutofill() {
      const link = (linkInput?.value || '').trim();
      if (!link) { alert('請先貼上連結'); return; }

      const resp = await fetch('{{ url_for("autofill") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ link })
      });
      const data = await resp.json();
      if (!data.ok) { alert(data.error || 'AutoFill 失敗'); return; }
      const m = data.meta || {};

      // 帶入隱藏欄位
      titleInput.value  = m.title  || '';
      artistInput.value = m.artist || '';

      // 縮圖
      if (m.thumbnail) {
        setThumbnail(m.thumbnail);
      } else {
        setThumbnail('');
      }

      // 歌名—歌手（上面黃字）
      setTitleArtist(titleInput.value, artistInput.value);

      // 翻面（由背面 → 正面）
      card.classList.add('flip');
    }

    // 綁定
    if (document.getElementById('btn-autofill')) {
      document.getElementById('btn-autofill').addEventListener('click', doAutofill);
    }
    if (linkInput) {
      linkInput.addEventListener('change', doAutofill);
    }
    if (reasonInput) {
      // 你如果之後要把推薦理由印在卡面，可在這裡即時同步
    }

    // 提交表單 → 抽卡展示（維持原本流程，但卡片改成照片版）
    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const fd = new FormData(form);
        const resp = await fetch(form.action, { method: 'POST', body: fd });
        const data = await resp.json();
        if (!data.ok) {
          alert(data.error || 'Error');
          return;
        }

        const resultDiv = document.getElementById('draw-result');
        resultDiv.style.display = 'block';

        if (data.drawn) {
          const d = data.drawn;
          const signer    = d.nickname ? d.nickname : '';
          const reasonTxt = d.reason   ? d.reason   : '';
          const titleTxt  = d.title    ? d.title    : '';
          const artistTxt = d.artist   ? d.artist   : '';
          const bgStyle   = d.thumbnail ? ' style="background-image:url(' + d.thumbnail + ')"' : '';

          // 照片版 Polaroid（與預覽一致）
          resultDiv.innerHTML = `
            <div class="polaroid-container">
              <div class="polaroid" id="draw-polaroid">
                <div class="face back"></div>
                <div class="face front">
                  <div class="window"${bgStyle}>
                    ${d.thumbnail ? '<img alt="thumb" src="'+d.thumbnail+'"/>' : '<img alt="thumb" />'}
                  </div>
                  <div class="song-line">
                    <span class="zh">${titleTxt || '(No title)'}</span>
                    <span class="sep"${artistTxt ? '' : ' style="display:none;"'}> — </span>
                    <span class="en">${artistTxt || ''}</span>
                  </div>
                </div>
              </div>
            </div>
            <div style="margin-top:8px; text-align:center;">
              ${signer ? '<div><strong>'+signer+'</strong></div>' : ''}
              ${reasonTxt ? '<div>'+reasonTxt+(d.link ? ' <span class="play-link"><a href="'+d.link+'" target="_blank" rel="noopener">Play</a></span>' : '')+'</div>' : (d.link ? '<div class="play-link"><a href="'+d.link+'" target="_blank" rel="noopener">Play</a></div>' : '')}
            </div>
          `;
          setTimeout(() => {
            const p = document.getElementById('draw-polaroid');
            if (p) p.classList.add('flip');
          }, 200);
        } else {
          resultDiv.textContent = 'No other songs yet—invite friends!';
        }

        form.reset();
      });
    }
  </script>
{% endblock %}
