{% extends 'base.html' %}
{% block content %}
  <!-- Polaroid Preview Stage -->
  <div class="polaroid-stage">
    <div class="polaroid-container">
      <div class="polaroid" id="preview-polaroid">
        <!-- 背面：灰黑 -->
        <div class="polaroid-face back">
          <div class="back-content">
            <div class="back-seal">NewMood</div>
          </div>
        </div>
        <!-- 正面：白底 + 外框 + 方形相紙窗 -->
        <div class="polaroid-face front">
          <div class="frame">
            <div class="band top"><span id="band-top-text">等待自動帶入…</span></div>
            <div class="photo" id="preview-cover"><span class="cover-icon" id="cover-icon">🎵</span></div>
            <div class="band bottom"><span id="band-bottom-text"></span></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% if not user %}
    <div class="sticky-wrap"><div class="sticky yellow">
      <p>Login to post your song and draw a random pick from others.</p>
      <a class="btn" href="{{ url_for('login') }}">Login with Google</a>
    </div></div>
  {% else %}
    <div class="sticky-wrap"><div class="sticky blue">
      <form id="post-form" method="post" action="{{ url_for('submit') }}">
        <label>Link (YouTube Music / Spotify / Apple Music)</label>
        <input type="url" name="link" id="input-link" placeholder="https://..." />

        <!-- Title/Artist 由 AutoFill 寫入的隱藏欄位 -->
        <input type="hidden" name="title" id="input-title" />
        <input type="hidden" name="artist" id="input-artist" />

        <label>Why do you recommend it? (optional)</label>
        <textarea name="reason" id="input-reason" rows="3" placeholder="Short reason..."></textarea>

        <div style="display:flex; gap:8px; margin-top:8px;">
          <button class="btn" type="button" id="btn-autofill">AutoFill</button>
          <button class="btn" type="submit">Post & Draw</button>
        </div>
      </form>
      <div id="draw-result" class="draw-area" style="display:none;"></div>
    </div></div>
  {% endif %}
  <script id="boot-data" type="application/json">
    {{ {'nickname': (user.nickname if user else None)} | tojson }}
  </script>
  <script>
  // …前略（上面的程式碼不變）

  // 簡單淨化，避免把奇怪字元插進 HTML
  const safe = (s) => (s ?? '').toString();

  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(form);
      const resp = await fetch(form.action, { method: 'POST', body: fd });
      const data = await resp.json();
      if (!data.ok) { alert(data.error || 'Error'); return; }

      const result = document.getElementById('draw-result');
      result.style.display = 'block';

      if (data.drawn) {
        const d = data.drawn;
        const signer = d.nickname ? d.nickname : '';
        const reason = d.reason ? d.reason : '';

        // 先把 style 字串組好（避免在樣板字串裡再拼反引號）
        const bgStyle = d.thumbnail
          ? ' style="background-image:url(' + d.thumbnail + ');background-size:cover;background-position:center;background-repeat:no-repeat;"'
          : '';

        // ✅ 這裡一定要有結尾的 ` 和 ;
        result.innerHTML = `
          <div class="polaroid-container">
            <div class="polaroid" id="draw-polaroid">
              <div class="polaroid-face back">
                <div class="back-content"><div class="back-seal">NewMood</div></div>
              </div>
              <div class="polaroid-face front">
                <div class="frame">
                  <div class="band top">
                    <span><strong>${safe(d.title)}</strong>${signer ? ' — ' + safe(signer) : ''}</span>
                  </div>
                  <div class="photo"${bgStyle}>
                    ${d.thumbnail ? '' : '<span class="cover-icon">🎵</span>'}
                  </div>
                  <div class="band bottom">
                    <span>
                      ${safe(reason)}
                      ${d.link ? '<span class="play-link" style="margin-left:6px;"><a href="' + d.link + '" target="_blank" rel="noopener">Play</a></span>' : ''}
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `; // ← 收尾的反引號與分號

        setTimeout(() => document.getElementById('draw-polaroid')?.classList.add('flip'), 220);
      } else {
        result.textContent = 'No other songs yet—invite friends!';
      }

      form.reset();
    });
  }
</script>