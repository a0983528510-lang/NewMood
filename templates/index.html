{% extends 'base.html' %}
{% block content %}
  <!-- 預覽區：拍立得翻轉 -->
  <div class="polaroid-stage">
    <div class="polaroid-container">
      <div class="polaroid instax-mini" id="preview-polaroid">
        <!-- 背面（全 CSS 幾何塊） -->
        <div class="polaroid-face back">
          <div class="back-card">
            <div class="back-strip top"></div>
            <div class="back-strip bottom"></div>
            <div class="back-dash">Paste Link</div>
            <div class="back-brand">
              <span>NewMood</span><span>NewMood</span><span>NewMood</span>
            </div>
          </div>
        </div>

        <!-- 正面（白色拍立得） -->
        <div class="polaroid-face front">
          <div class="frame">
            <!-- 相片窗 -->
            <div class="photo">
              <div class="cover" id="preview-cover">
                <span class="cover-icon" id="cover-icon">🎵</span>
              </div>

              <!-- 黃色斜體歌名－作者 -->
              <div class="overlay-title" id="overlay-title">Title — Artist</div>
            </div>

            <!-- 文字區塊（推薦人、理由、右下角品牌） -->
            <div class="info">
              <div class="signer" id="signer-name">YOUR NAME</div>
              <div class="reason" id="reason-text"></div>
              <div class="brand-mark">NewMood</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% if not user %}
    <div class="sticky-wrap"><div class="sticky yellow">
      <p>Login to post your song and draw a random pick from others.</p>
      <a class="btn" href="{{ url_for('login') }}">Login with Google</a>
    </div></div>
  {% else %}
    <div class="sticky-wrap"><div class="sticky blue" style="background:transparent;border:none;box-shadow:none;">
      <form id="post-form" method="post" action="{{ url_for('submit') }}">
        <!-- 隱藏欄位：仍沿用 -->
        <input type="hidden" name="title" id="input-title" />
        <input type="hidden" name="artist" id="input-artist" />

        <!-- URL + 黃色 AutoFill（與 Figma 對齊） -->
        <div class="form-row">
          <input type="url" name="link" id="input-link" class="input-url"
                 placeholder="SONG LINK（YouTube Music / Spotify / Apple Music）" />
          <button class="btn-yellow" type="button" id="btn-autofill">FILL</button>
        </div>

        <!-- Link to：三個圓形快速連結 -->
        <div class="quick-links">
          <span class="quick-label">LINK TO：</span>
          <a class="quick-btn yt" href="https://music.youtube.com" target="_blank" rel="noopener" aria-label="YouTube Music"></a>
          <a class="quick-btn sp" href="https://open.spotify.com" target="_blank" rel="noopener" aria-label="Spotify"></a>
          <a class="quick-btn am" href="https://music.apple.com" target="_blank" rel="noopener" aria-label="Apple Music"></a>
        </div>

        <!-- 理由輸入框（大白框） -->
        <div class="textarea-row">
          <textarea name="reason" id="input-reason" rows="4"
            placeholder="WHY DO YOU RECOMMEND IT ? (Optional)"></textarea>
        </div>

        <!-- 送出按鈕 -->
        <div class="submit-row">
          <button class="btn-pill" type="submit">Post & Draw</button>
        </div>
      </form>

      <div id="draw-result" class="draw-area" style="display:none;"></div>
    </div></div>
  {% endif %}

  <!-- Boot-data：將暱稱輸出成 JSON，JS 解析後使用 -->
  <script id="boot-data" type="application/json">
    {{ {'nickname': (user.nickname if user else None)} | tojson }}
  </script>

  <script>
    const $ = (s) => document.querySelector(s);
    const form = document.getElementById('post-form');
    const linkInput = document.getElementById('input-link');
    const titleInput = document.getElementById('input-title');
    const artistInput = document.getElementById('input-artist');
    const reasonInput = document.getElementById('input-reason');

    // 預覽元件
    const preview    = document.getElementById('preview-polaroid');
    const cover      = document.getElementById('preview-cover');
    const coverIcon  = document.getElementById('cover-icon');
    const overlay    = document.getElementById('overlay-title');
    const signerEl   = document.getElementById('signer-name');
    const reasonEl   = document.getElementById('reason-text');

    // 暱稱
    const boot = JSON.parse(document.getElementById('boot-data').textContent);
    const nickname = boot.nickname || '';

    // 自動填入
    async function doAutofill() {
      const link = (linkInput.value || '').trim();
      if (!link) { alert('請先貼上連結'); return; }

      const resp = await fetch('{{ url_for("autofill") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ link })
      });
      const data = await resp.json();
      if (!data.ok) { alert(data.error || 'AutoFill 失敗'); return; }
      const m = data.meta || {};

      // 隱藏欄位
      if (m.title)  titleInput.value  = m.title;
      if (m.artist) artistInput.value = m.artist;

      // 圖片
      if (m.thumbnail) {
        cover.style.backgroundImage = 'url(' + m.thumbnail + ')';
        coverIcon.style.display = 'none';
      } else {
        cover.style.backgroundImage = '';
        coverIcon.style.display = '';
      }

      // 覆蓋標題：Title — Artist（黃色斜體）
      const t = titleInput.value || '(No title)';
      const a = artistInput.value || '';
      overlay.textContent = a ? `${t} — ${a}` : t;

      // 推薦人 / 理由
      signerEl.textContent = nickname || '';
      reasonEl.textContent = reasonInput.value || '';

      // 翻轉動畫（加一圈旋轉）
      preview.classList.remove('flip','spin');
      void preview.offsetWidth; // 重新觸發動畫
      preview.classList.add('flip','spin');
    }

    // 綁定
    const btnAuto = document.getElementById('btn-autofill');
    if (btnAuto) btnAuto.addEventListener('click', doAutofill);
    if (linkInput) linkInput.addEventListener('change', doAutofill);
    if (reasonInput) {
      reasonInput.addEventListener('input', () => {
        reasonEl.textContent = reasonInput.value || '';
      });
    }

    // 提交 → 抽卡展示（維持原流程；卡片樣式沿用本頁）
    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const fd = new FormData(form);
        const resp = await fetch(form.action, { method: 'POST', body: fd });
        const data = await resp.json();
        if (!data.ok) { alert(data.error || 'Error'); return; }

        const resultDiv = document.getElementById('draw-result');
        resultDiv.style.display = 'block';

        if (data.drawn) {
          const d = data.drawn;
          const signer    = d.nickname ? d.nickname : '';
          const reasonTxt = d.reason   ? d.reason   : '';
          const bgStyle   = d.thumbnail ? ' style="background-image:url(' + d.thumbnail + ')"' : '';

          resultDiv.innerHTML = `
          <div class="polaroid-container">
            <div class="polaroid instax-mini" id="draw-polaroid">
              <div class="polaroid-face back">
                <div class="back-card">
                  <div class="back-strip top"></div>
                  <div class="back-strip bottom"></div>
                  <div class="back-dash">Play</div>
                  <div class="back-brand"><span>NewMood</span><span>NewMood</span><span>NewMood</span></div>
                </div>
              </div>
              <div class="polaroid-face front">
                <div class="frame">
                  <div class="photo">
                    <div class="cover"${bgStyle}>${d.thumbnail ? '' : '<span class="cover-icon">🎵</span>'}</div>
                    <div class="overlay-title">${d.title}${d.artist ? ' — ' + d.artist : ''}</div>
                  </div>
                  <div class="info">
                    <div class="signer">${signer}</div>
                    <div class="reason">${reasonTxt}${d.link ? ' <span class="play-link"><a href="'+d.link+'" target="_blank" rel="noopener">Play</a></span>' : ''}</div>
                    <div class="brand-mark">NewMood</div>
                  </div>
                </div>
              </div>
            </div>
          </div>`;

          setTimeout(() => {
            const p = document.getElementById('draw-polaroid');
            if (p) { p.classList.add('flip','spin'); }
          }, 200);
        } else {
          resultDiv.textContent = 'No other songs yet—invite friends!';
        }

        form.reset();
      });
    }
  </script>
{% endblock %}
